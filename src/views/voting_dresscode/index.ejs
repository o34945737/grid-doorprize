<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Voting Dresscode</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .card-img-top { height: 240px; object-fit: cover; }
    .candidate-card { border-radius: 14px; overflow: hidden; }
    .picked { outline: 4px solid rgba(245, 158, 11, .9); }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="m-0">ðŸ‘— Voting Dresscode</h4>
      <div class="text-muted small">Pilih <b>1 Male</b> dan <b>1 Female</b>, lalu klik <b>Submit Vote</b>.</div>
    </div>
    <div>
      <a href="/voting-dresscode/results" class="btn btn-outline-secondary btn-sm">Lihat Hasil</a>
    </div>
  </div>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <% if ((!maleRows || !maleRows.length) && (!femaleRows || !femaleRows.length)) { %>
    <div class="alert alert-warning">Belum ada kandidat diupload.</div>
  <% } else { %>

    <div class="row g-3">
      <div class="col-12 col-lg-6">
        <h5 class="mb-2">Male</h5>
        <div class="row g-3">
          <% (maleRows || []).forEach(r => { %>
            <div class="col-12 col-sm-6">
              <div class="card candidate-card shadow-sm" data-gender="M" data-id="<%= r.id %>" onclick="pick('M', <%= r.id %>, this)">
                <img src="<%= r.photo_url %>" class="card-img-top" alt="photo">
                <div class="card-body">
                  <div class="fw-bold"><%= r.photo_name %></div>
                  <div class="text-muted small">ID: <%= r.id %></div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <h5 class="mb-2">Female</h5>
        <div class="row g-3">
          <% (femaleRows || []).forEach(r => { %>
            <div class="col-12 col-sm-6">
              <div class="card candidate-card shadow-sm" data-gender="F" data-id="<%= r.id %>" onclick="pick('F', <%= r.id %>, this)">
                <img src="<%= r.photo_url %>" class="card-img-top" alt="photo">
                <div class="card-body">
                  <div class="fw-bold"><%= r.photo_name %></div>
                  <div class="text-muted small">ID: <%= r.id %></div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="text-muted">
          Selected Male: <b id="selM">-</b> â€¢ Selected Female: <b id="selF">-</b>
        </div>
        <button class="btn btn-warning" onclick="submitVote()">Submit Vote</button>
      </div>
    </div>

  <% } %>
</div>

<script>
let pickedM = null;
let pickedF = null;

function pick(g, id, el){
  // remove picked in same gender
  document.querySelectorAll(`.candidate-card[data-gender="${g}"]`).forEach(c => c.classList.remove("picked"));
  el.classList.add("picked");

  if(g === "M") { pickedM = id; document.getElementById("selM").textContent = id; }
  if(g === "F") { pickedF = id; document.getElementById("selF").textContent = id; }
}

async function submitVote(){
  if(!pickedM) return Swal.fire("Belum lengkap", "Pilih 1 kandidat Male.", "warning");
  if(!pickedF) return Swal.fire("Belum lengkap", "Pilih 1 kandidat Female.", "warning");

  const ok = await Swal.fire({
    title: "Konfirmasi Vote",
    html: `Kamu akan submit vote untuk:<br>Male ID: <b>${pickedM}</b><br>Female ID: <b>${pickedF}</b>`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Ya, Submit",
    cancelButtonText: "Batal",
    confirmButtonColor: "#f59e0b",
    reverseButtons: true
  });
  if(!ok.isConfirmed) return;

  try{
    // vote male
    let r = await fetch("/voting-dresscode/api/vote", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ candidate_id: pickedM })
    });
    let j = await r.json().catch(()=>({}));
    if(!r.ok || !j.ok) return Swal.fire("Gagal", j.error || "Vote male gagal", "error");

    // vote female
    r = await fetch("/voting-dresscode/api/vote", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ candidate_id: pickedF })
    });
    j = await r.json().catch(()=>({}));
    if(!r.ok || !j.ok) return Swal.fire("Gagal", j.error || "Vote female gagal", "error");

    await Swal.fire({ title:"Berhasil", text:"Vote kamu tercatat âœ…", icon:"success" });
  }catch(e){
    console.error(e);
    Swal.fire("Error", "Server error", "error");
  }
}
</script>

</body>
</html>
