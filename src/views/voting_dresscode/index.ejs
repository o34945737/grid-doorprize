<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Voting Dresscode</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="m-0">ðŸ‘— Voting Dresscode</h4>
      <div class="text-muted small">Klik tombol <b>Vote</b> untuk memilih.</div>
    </div>
    <a href="/voting-dresscode/admin" class="btn btn-outline-secondary btn-sm">Admin</a>
  </div>

  <div class="row g-3">
    <% if (!rows || !rows.length) { %>
      <div class="col-12">
        <div class="alert alert-secondary">Belum ada kandidat diupload.</div>
      </div>
    <% } %>

    <% (rows || []).forEach(r => { %>
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card h-100 shadow-sm" style="border-radius:16px;">
          <img src="<%= r.photo_url %>" class="card-img-top"
               style="height:220px; object-fit:cover; border-top-left-radius:16px; border-top-right-radius:16px;">
          <div class="card-body">
            <div class="fw-bold"><%= r.photo_name %></div>

            <div class="mt-2 small text-muted">
              Votes: <b id="vc-<%= r.id %>"><%= r.vote_count %></b>
            </div>

            <button class="btn btn-warning w-100 mt-2"
                    onclick="voteNow(<%= r.id %>)"
                    id="btn-<%= r.id %>">
              Vote
            </button>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</div>

<script>
async function voteNow(id){
  const btn = document.getElementById("btn-" + id);
  if (btn) btn.disabled = true;

  try{
    const r = await fetch("/voting-dresscode/api/vote", {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ candidate_id: id })
    });

    const j = await r.json().catch(()=> ({}));

    if(!r.ok || !j.ok){
      if (btn) btn.disabled = false;
      return Swal.fire("Gagal", j.error || "Vote gagal", "error");
    }

    const el = document.getElementById("vc-" + id);
    if (el && typeof j.vote_count === "number") el.textContent = String(j.vote_count);

    await Swal.fire({
      title: "Terima kasih!",
      text: "Vote kamu berhasil masuk âœ…",
      icon: "success",
      timer: 1100,
      showConfirmButton: false
    });
  }catch(err){
    console.error(err);
    if (btn) btn.disabled = false;
    Swal.fire("Error", "Server error", "error");
  }
}
</script>

</body>
</html>
