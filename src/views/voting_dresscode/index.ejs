<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dresscode Voting</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .card-img-top { height: 240px; object-fit: cover; }
    .candidate-card { border-radius: 14px; overflow: hidden; cursor: pointer; transition: .15s ease; }
    .candidate-card:hover { transform: translateY(-2px); }
    .picked { outline: 4px solid rgba(245, 158, 11, .9); }
    .gender-badge { font-size: 12px; }
    .section-title { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="m-0">Dresscode Voting</h4>
      <div class="text-muted small">
        Select <b>1 Male</b> and <b>1 Female</b>, then click <b>Submit Vote</b>.
      </div>
    </div>
    <div class="d-flex gap-2">
      <a href="/voting-dresscode/results" class="btn btn-outline-secondary btn-sm">
        View Results
      </a>
    </div>
  </div>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <% if ((!maleRows || !maleRows.length) && (!femaleRows || !femaleRows.length)) { %>
    <div class="alert alert-warning">No candidates have been uploaded yet.</div>
  <% } else { %>

    <!-- ROW 1: MALE -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="section-title mb-2">
          <h5 class="m-0">Male</h5>
          <span class="badge text-bg-primary gender-badge">Row 1</span>
        </div>

        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3">
          <% (maleRows || []).slice(0,5).forEach(r => { %>
            <div class="col">
              <div class="card candidate-card shadow-sm"
                   data-gender="M"
                   data-id="<%= r.id %>"
                   onclick="pick('M', <%= r.id %>, this)">
                <img src="<%= r.photo_url %>" class="card-img-top" alt="photo">
                <div class="card-body">
                  <div class="fw-bold text-truncate"><%= r.photo_name %></div>
                  <div class="text-muted small">ID: <%= r.id %></div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <% if ((maleRows || []).length > 5) { %>
          <div class="text-muted small mt-2">
            * Total <b><%= maleRows.length %></b> male candidates. Only the first 5 are shown.
          </div>
        <% } %>
      </div>
    </div>

    <!-- ROW 2: FEMALE -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="section-title mb-2">
          <h5 class="m-0">Female</h5>
          <span class="badge text-bg-danger gender-badge">Row 2</span>
        </div>

        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3">
          <% (femaleRows || []).slice(0,5).forEach(r => { %>
            <div class="col">
              <div class="card candidate-card shadow-sm"
                   data-gender="F"
                   data-id="<%= r.id %>"
                   onclick="pick('F', <%= r.id %>, this)">
                <img src="<%= r.photo_url %>" class="card-img-top" alt="photo">
                <div class="card-body">
                  <div class="fw-bold text-truncate"><%= r.photo_name %></div>
                  <div class="text-muted small">ID: <%= r.id %></div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <% if ((femaleRows || []).length > 5) { %>
          <div class="text-muted small mt-2">
            * Total <b><%= femaleRows.length %></b> female candidates. Only the first 5 are shown.
          </div>
        <% } %>
      </div>
    </div>

    <!-- SUBMIT -->
    <div class="card mt-3">
      <div class="card-body d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="text-muted">
          Selected Male: <b id="selM">-</b> • Selected Female: <b id="selF">-</b>
        </div>
        <button class="btn btn-warning px-4" onclick="submitVote()">
          Submit Vote
        </button>
      </div>
    </div>

  <% } %>
</div>

<script>
  let pickedM = null;
  let pickedF = null;

  function pick(g, id, el){
    document.querySelectorAll(`.candidate-card[data-gender="${g}"]`).forEach(c => c.classList.remove("picked"));
    el.classList.add("picked");

    if(g === "M") { pickedM = id; document.getElementById("selM").textContent = id; }
    if(g === "F") { pickedF = id; document.getElementById("selF").textContent = id; }
  }

  async function submitVote(){
    if(!pickedM) return Swal.fire("Incomplete", "Please pick 1 Male candidate.", "warning");
    if(!pickedF) return Swal.fire("Incomplete", "Please pick 1 Female candidate.", "warning");

    const ok = await Swal.fire({
      title: "Confirm Vote",
      html: `Submit vote for:<br>Male ID: <b>${pickedM}</b><br>Female ID: <b>${pickedF}</b>`,
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "Yes, Submit",
      cancelButtonText: "Cancel",
      confirmButtonColor: "#f59e0b",
      reverseButtons: true
    });
    if(!ok.isConfirmed) return;

    try{
      // optional: disable button biar gak double submit
      const btn = document.querySelector("button.btn.btn-warning");
      if (btn) btn.disabled = true;

      // vote male
      let r = await fetch("/voting-dresscode/api/vote", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify({ candidate_id: pickedM })
      });
      let j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok){
        if (btn) btn.disabled = false;
        return Swal.fire("Failed", j.error || "Male vote failed", "error");
      }

      // vote female
      r = await fetch("/voting-dresscode/api/vote", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify({ candidate_id: pickedF })
      });
      j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok){
        if (btn) btn.disabled = false;
        return Swal.fire("Failed", j.error || "Female vote failed", "error");
      }

      await Swal.fire({
        title: "Success",
        text: "Your vote has been submitted ✅ Redirecting to results...",
        icon: "success",
        timer: 1200,
        showConfirmButton: false
      });

      // ✅ redirect ke results
      window.location.href = "/voting-dresscode/results";
    } catch(e){
      console.error(e);
      Swal.fire("Error", "Server error", "error");
    }
  }

</script>

</body>
</html>
