<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Voting Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .mini { font-size: 12px; }
    .rank-name { font-weight: 700; }
    .rank-votes { font-size: 13px; color: #6c757d; }
    .chip {
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid #e9ecef; border-radius:999px;
      padding:4px 10px; background:#fff;
    }
    .dot {
      width:10px; height:10px; border-radius:50%;
      background:#adb5bd; display:inline-block;
    }
    .dot.ok { background:#198754; }
    .dot.bad { background:#dc3545; }
  </style>
</head>

<body class="p-4 bg-light">
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="m-0">ðŸ“Š Voting Results</h4>
      <div class="text-muted small">Login: <b><%= admin.username %></b></div>
      <div class="mt-2 d-flex flex-wrap gap-2">
        <span class="chip">
          <span id="sseDot" class="dot"></span>
          <span class="mini" id="sseText">Connectingâ€¦</span>
        </span>
        <span class="chip">
          <span class="mini text-muted">Last update:</span>
          <span class="mini" id="lastUpdate">-</span>
        </span>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a href="/voting-dresscode/admin" class="btn btn-outline-secondary btn-sm">Dashboard</a>
      <a href="/voting-dresscode/admin/candidates" class="btn btn-outline-secondary btn-sm">Candidates</a>
      <a href="/voting-dresscode/admin/logout" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <div class="fw-bold mb-2">Male Ranking</div>

          <div id="maleEmpty" class="text-muted" style="display:none;">No data yet.</div>
          <ol id="maleList" class="mb-0">
            <% (maleRows || []).forEach(r => { %>
              <li class="mb-2">
                <div class="rank-name"><%= r.photo_name %></div>
                <div class="rank-votes">Votes: <b><%= r.vote_count %></b></div>
              </li>
            <% }) %>
          </ol>

        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <div class="fw-bold mb-2">Female Ranking</div>

          <div id="femaleEmpty" class="text-muted" style="display:none;">No data yet.</div>
          <ol id="femaleList" class="mb-0">
            <% (femaleRows || []).forEach(r => { %>
              <li class="mb-2">
                <div class="rank-name"><%= r.photo_name %></div>
                <div class="rank-votes">Votes: <b><%= r.vote_count %></b></div>
              </li>
            <% }) %>
          </ol>

        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const $ = (id) => document.getElementById(id);

  function setSseStatus(ok, text){
    const dot = $("sseDot");
    const t = $("sseText");
    if(!dot || !t) return;

    dot.classList.remove("ok","bad");
    dot.classList.add(ok ? "ok" : "bad");
    t.textContent = text || (ok ? "Connected" : "Disconnected");
  }

  function setLastUpdate(){
    const el = $("lastUpdate");
    if(!el) return;
    el.textContent = new Date().toLocaleString();
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function renderList(listEl, emptyEl, rows){
    if(!listEl || !emptyEl) return;

    const arr = Array.isArray(rows) ? rows : [];
    if(arr.length === 0){
      listEl.innerHTML = "";
      emptyEl.style.display = "block";
      return;
    }

    emptyEl.style.display = "none";
    listEl.innerHTML = arr.map(r => `
      <li class="mb-2">
        <div class="rank-name">${escapeHtml(r.photo_name)}</div>
        <div class="rank-votes">Votes: <b>${Number(r.vote_count || 0)}</b></div>
      </li>
    `).join("");
  }

  async function refreshResults(){
    const r = await fetch("/voting-dresscode/api/results.json", {
      headers: { "Accept":"application/json" }
    });
    const j = await r.json().catch(()=>({}));

    if(!r.ok || !j.ok) throw new Error(j.error || "Failed to load results");

    renderList($("maleList"), $("maleEmpty"), j.maleRows);
    renderList($("femaleList"), $("femaleEmpty"), j.femaleRows);
    setLastUpdate();
  }

  // initial state from server-rendered HTML:
  // show empty text if needed
  (function initEmpty(){
    const maleHas = $("maleList")?.children?.length > 0;
    const femaleHas = $("femaleList")?.children?.length > 0;
    if($("maleEmpty")) $("maleEmpty").style.display = maleHas ? "none" : "block";
    if($("femaleEmpty")) $("femaleEmpty").style.display = femaleHas ? "none" : "block";
  })();

  // SSE realtime
  let es;
  function connectSse(){
    setSseStatus(false, "Connectingâ€¦");

    es = new EventSource("/voting-dresscode/api/results/stream");

    es.onopen = () => {
      setSseStatus(true, "Connected (live)");
    };

    es.onmessage = async (ev) => {
      // server sends ping/connected/results_updated
      try{
        const msg = JSON.parse(ev.data || "{}");
        if(msg.type === "results_updated"){
          // fetch fresh snapshot
          await refreshResults();
        }
      }catch(_){
        // ignore parse errors
      }
    };

    es.onerror = async () => {
      setSseStatus(false, "Disconnected (retrying)");
      try { es.close(); } catch(_){}
      // browser will retry automatically; we keep UI status only
    };
  }

  // do 1 refresh at start so numbers always latest
  (async function(){
    try { await refreshResults(); } catch(e){ console.warn(e); }
    connectSse();
  })();
</script>

</body>
</html>
