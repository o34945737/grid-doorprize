<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Voting Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: radial-gradient(circle at top, #fff3cd, #f8f9fa); }

    .winner-wrap { display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 992px){ .winner-wrap { grid-template-columns: 1fr 1fr; } }

    .winner-card{
      border-radius:18px; overflow:hidden;
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: 0 12px 40px rgba(0,0,0,.08);
      background:#fff;
      position: relative;
      transform: translateY(0);
      transition: transform .25s ease;
    }
    .winner-card:hover{ transform: translateY(-2px); }

    .winner-hero{
      height: 320px; width: 100%;
      object-fit: cover;
      display:block;
      background:#f1f3f5;
    }

    .badge-top{
      position:absolute; top:14px; left:14px;
      background: rgba(255,193,7,.95);
      color:#111;
      font-weight:800;
      border-radius:999px;
      padding:8px 12px;
      box-shadow: 0 8px 20px rgba(255,193,7,.35);
    }

    .winner-body{ padding:14px 16px 16px; }
    .winner-title{ font-size: 18px; font-weight: 800; margin:0; }
    .winner-sub{ color:#6c757d; font-size: 13px; margin-top:2px; }
    .winner-votes{
      margin-top:10px;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:12px;
      background: #fff7e6;
      border: 1px solid rgba(255,193,7,.3);
      font-weight:700;
    }

    /* animasi glow ketika winner berubah */
    .pop{
      animation: pop .55s ease;
    }
    @keyframes pop{
      0% { transform: scale(.98); box-shadow: 0 0 0 rgba(255,193,7,0); }
      40% { transform: scale(1.02); box-shadow: 0 0 40px rgba(255,193,7,.35); }
      100% { transform: scale(1); }
    }

    /* confetti canvas */
    .confetti{
      position:fixed; inset:0; pointer-events:none; z-index: 9999;
    }

    .mini{
      font-size: 12px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid rgba(0,0,0,.08);
      border-radius:999px; padding:6px 12px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:#adb5bd; display:inline-block; }
    .dot.ok{ background:#198754; }
    .dot.bad{ background:#dc3545; }
  </style>
</head>

<body>
<canvas id="confetti" class="confetti"></canvas>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="m-0">üìä Live Results</h4>
      <div class="text-muted small">Top winners update automatically (realtime).</div>

      <div class="mt-2 d-flex flex-wrap gap-2">
        <span class="chip">
          <span id="sseDot" class="dot"></span>
          <span class="mini" id="sseText">Connecting‚Ä¶</span>
        </span>
        <span class="chip">
          <span class="mini text-muted">Last update:</span>
          <span class="mini" id="lastUpdate">-</span>
        </span>
      </div>
    </div>

    <a href="/voting-dresscode/" class="btn btn-outline-secondary btn-sm">Back</a>
  </div>

  <!-- WINNERS -->
  <div class="winner-wrap mb-4">
    <!-- Male winner -->
    <div id="maleWinnerCard" class="winner-card">
      <div class="badge-top">üèÜ TOP MALE</div>
      <img id="maleImg" class="winner-hero" src="" alt="Male winner">
      <div class="winner-body">
        <h5 id="maleName" class="winner-title">-</h5>
        <div class="winner-sub">Male category</div>
        <div class="winner-votes">
          <span>Votes</span>
          <span id="maleVotes">0</span>
        </div>
      </div>
    </div>

    <!-- Female winner -->
    <div id="femaleWinnerCard" class="winner-card">
      <div class="badge-top">üèÜ TOP FEMALE</div>
      <img id="femaleImg" class="winner-hero" src="" alt="Female winner">
      <div class="winner-body">
        <h5 id="femaleName" class="winner-title">-</h5>
        <div class="winner-sub">Female category</div>
        <div class="winner-votes">
          <span>Votes</span>
          <span id="femaleVotes">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- (optional) ranking list bawah -->
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card"><div class="card-body">
        <div class="fw-bold mb-2">Male Ranking</div>
        <ol id="maleList" class="mb-0"></ol>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card"><div class="card-body">
        <div class="fw-bold mb-2">Female Ranking</div>
        <ol id="femaleList" class="mb-0"></ol>
      </div></div>
    </div>
  </div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setSse(ok, text){
    const dot = $("sseDot"), t = $("sseText");
    dot.classList.remove("ok","bad");
    dot.classList.add(ok ? "ok" : "bad");
    t.textContent = text || (ok ? "Connected" : "Disconnected");
  }
  function setLastUpdate(){
    $("lastUpdate").textContent = new Date().toLocaleString();
  }

  // --- confetti sederhana (tanpa library) ---
  const canvas = $("confetti");
  const ctx = canvas.getContext("2d");
  let parts = [];

  function resize(){
    canvas.width = innerWidth;
    canvas.height = innerHeight;
  }
  addEventListener("resize", resize);
  resize();

  function burst(){
    const n = 140;
    const x = innerWidth / 2;
    const y = innerHeight * 0.20;

    for(let i=0;i<n;i++){
      parts.push({
        x, y,
        vx: (Math.random()-0.5)*12,
        vy: (Math.random()-1.2)*12,
        g: 0.22 + Math.random()*0.08,
        life: 80 + Math.random()*40,
        s: 2 + Math.random()*4,
        rot: Math.random()*Math.PI
      });
    }
  }

  function tick(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    parts = parts.filter(p=>p.life>0);

    for(const p of parts){
      p.life -= 1;
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;

      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot);
      ctx.globalAlpha = Math.max(0, p.life/120);
      ctx.fillRect(-p.s, -p.s, p.s*2, p.s*2);
      ctx.restore();
    }
    requestAnimationFrame(tick);
  }
  tick();

  // --- render ---
  let lastWinner = { mId: null, fId: null };

  function renderRanking(listEl, rows){
    listEl.innerHTML = (rows || []).slice(0, 10).map(r=>`
      <li class="mb-2">
        <b>${esc(r.photo_name)}</b> ‚Äî üó≥ ${Number(r.vote_count||0)}
      </li>
    `).join("");
  }

  function pop(el){
    el.classList.remove("pop");
    void el.offsetWidth;
    el.classList.add("pop");
  }

  function setWinner(g, row){
    if(!row) return;

    if(g === "M"){
      $("maleImg").src = row.photo_url || "";
      $("maleName").textContent = row.photo_name || "-";
      $("maleVotes").textContent = Number(row.vote_count || 0);

      // kalau pemenang berubah ‚Üí animasi meriah
      if(lastWinner.mId !== row.id){
        lastWinner.mId = row.id;
        pop($("maleWinnerCard"));
        burst();
      }
    }

    if(g === "F"){
      $("femaleImg").src = row.photo_url || "";
      $("femaleName").textContent = row.photo_name || "-";
      $("femaleVotes").textContent = Number(row.vote_count || 0);

      if(lastWinner.fId !== row.id){
        lastWinner.fId = row.id;
        pop($("femaleWinnerCard"));
        burst();
      }
    }
  }

  async function refresh(){
    const r = await fetch("/voting-dresscode/api/results.json", { headers:{ "Accept":"application/json" }});
    const j = await r.json().catch(()=>({}));
    if(!r.ok || !j.ok) throw new Error(j.error || "Failed");

    const maleRows = j.maleRows || [];
    const femaleRows = j.femaleRows || [];

    // set winners = rank #1
    setWinner("M", maleRows[0]);
    setWinner("F", femaleRows[0]);

    // ranking list
    renderRanking($("maleList"), maleRows);
    renderRanking($("femaleList"), femaleRows);

    setLastUpdate();
  }

  // SSE
  function connect(){
    setSse(false, "Connecting‚Ä¶");
    const es = new EventSource("/voting-dresscode/api/results/stream");

    es.onopen = () => setSse(true, "Connected (live)");
    es.onerror = () => setSse(false, "Disconnected (retrying)");

    es.onmessage = async (ev)=>{
      try{
        const msg = JSON.parse(ev.data||"{}");
        if(msg.type === "results_updated"){
          await refresh();
        }
      }catch(_){}
    };
  }

  (async function(){
    try{ await refresh(); }catch(e){ console.warn(e); }
    connect();
  })();
</script>
</body>
</html>
